# Prefect deployment configuration
name: biomedical-graphrag

# Work pool configuration
work_pools:
  biomedical-pool:
    type: process
    description: "Process-based work pool for biomedical GraphRAG tasks"
    max_workers: 2
    concurrency_limit: 1  # Prevent concurrent runs to avoid rate limit issues

# Default deployment parameters
deployments:
  - name: weekly-incremental
    entrypoint: src/biomedical_graphrag/orchestration/flows.py:incremental_update
    work_pool:
      name: biomedical-pool
    schedule:
      cron: "0 2 * * 0"  # Every Sunday at 2 AM
      timezone: UTC
    parameters:
      search_terms:
        - "CRISPR gene editing"
        - "cancer immunotherapy"
        - "genome sequencing"
      max_results_per_term: 50
      batch_size: 50

  - name: monthly-rebuild
    entrypoint: src/biomedical_graphrag/orchestration/flows.py:full_rebuild
    work_pool:
      name: biomedical-pool
    schedule:
      cron: "0 3 1 * *"  # 1st of month at 3 AM
      timezone: UTC
    parameters:
      search_terms:
        - "CRISPR gene editing"
        - "cancer immunotherapy"
        - "genome sequencing"
        - "CAR-T cell therapy"
        - "mRNA vaccine"
      max_results_per_term: 200
      batch_size: 50

  - name: daily-validation
    entrypoint: src/biomedical_graphrag/orchestration/flows.py:consistency_check
    work_pool:
      name: biomedical-pool
    schedule:
      cron: "0 1 * * *"  # Every day at 1 AM
      timezone: UTC

# Prefect server/cloud configuration
prefect:
  # Use Prefect Cloud
  api_url: ${PREFECT__API_URL}
  api_key: ${PREFECT__API_KEY}

  # Or use local server (uncomment for self-hosted)
  # api_url: http://localhost:4200/api

# Pull configuration - Prefect Cloud will pull code from GitHub
pull:
  - prefect.deployments.steps.git_clone:
      repository: https://github.com/paul-data-ai/biomedical_graphrag.git
      branch: main
      access_token: null  # Public repo - no token needed. For private: use ${GITHUB_TOKEN}

# Build configuration - install package after cloning
build:
  - prefect.deployments.steps.run_shell_script:
      id: install-package
      script: |
        python -m pip install --upgrade pip
        pip install -e .
      stream_output: true
