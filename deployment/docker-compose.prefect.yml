version: '3.8'

services:
  # Prefect Worker (connected to Prefect Cloud)
  prefect-worker:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.prefect
    container_name: biomedical-prefect-worker
    environment:
      # Prefect Cloud Configuration
      - PREFECT_API_URL=${PREFECT__API_URL}
      - PREFECT_API_KEY=${PREFECT__API_KEY}
      # Application environment variables
      - OPENAI__API_KEY=${OPENAI__API_KEY}
      - NEO4J__URI=${NEO4J__URI}
      - NEO4J__USERNAME=${NEO4J__USERNAME}
      - NEO4J__PASSWORD=${NEO4J__PASSWORD}
      - QDRANT__URL=${QDRANT__URL}
      - QDRANT__API_KEY=${QDRANT__API_KEY}
      - PUBMED__EMAIL=${PUBMED__EMAIL}
      - PUBMED__API_KEY=${PUBMED__API_KEY}
    volumes:
      - ../data:/app/data  # Mount data directory
      - ../.env:/app/.env:ro  # Mount .env file (read-only)
    command: uv run prefect worker start --pool biomedical-pool --type process
    networks:
      - biomedical-net
    restart: unless-stopped

networks:
  biomedical-net:
    driver: bridge
